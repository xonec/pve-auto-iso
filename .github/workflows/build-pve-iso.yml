name: æ„å»ºæœ€æ–°ç‰ˆ PVE æ— äººå€¼å®ˆå®‰è£… ISO

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.version_check.outputs.need_build }}
      latest_iso: ${{ steps.get_iso.outputs.latest_iso }}
      version: ${{ steps.get_iso.outputs.version }}
    steps:
      - name: è·å–å®˜ç½‘æœ€æ–° ISO ç‰ˆæœ¬
        id: get_iso
        run: |
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ä»“åº“å·²å‘å¸ƒç‰ˆæœ¬
        id: version_check
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep 'tag_name' | cut -d'"' -f4 | sed 's/^v//; s/-.*//' || echo "0.0-0")
          if [ "$LATEST_RELEASE" != "${{ steps.get_iso.outputs.version }}" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
          fi

  build-iso:
    needs: check-version
    if: ${{ needs.check-version.outputs.need_build == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          curl -fsSL https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg] http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          sudo apt update -y
          sudo apt install -y proxmox-auto-install-assistant mtools libisoburn1 wget

      - name: è¯»å– TOML é…ç½®
        id: read_toml
        run: |
          extract_val() { grep "$1" pve-unattended.toml | sed -E 's/.*=[[:space:]]*"(.*)"/\1/' | tr -d '\r'; }
          ROOT_PWD=$(extract_val "root_password")
          NET_MODE=$(extract_val "source")
          if [ "$NET_MODE" = "from-answer" ]; then
            IP=$(extract_val "cidr")
            ADDR="é™æ€IP: $IP"
          else
            ADDR="DHCP è‡ªåŠ¨è·å–"
          fi
          echo "root_pwd=$ROOT_PWD" >> $GITHUB_OUTPUT
          echo "addr=$ADDR" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½ PVE åŸç‰ˆ ISO
        run: |
          mkdir -p /tmp/pve-iso
          wget --tries=3 --timeout=300 -O /tmp/pve-iso/pve-original.iso https://enterprise.proxmox.com/iso/${{ needs.check-version.outputs.latest_iso }}

      - name: åˆ¶ä½œæ— äººå€¼å®ˆ ISO
        run: |
          WORKING_DIR="/tmp/pve-iso"
          # å¼ºåˆ¶æŒ‡å®šè¾“å‡ºæ–‡ä»¶åï¼Œä¸å†è®©å·¥å…·éšå¿ƒæ‰€æ¬²
          OUTPUT_PATH="$WORKING_DIR/pve-final-output.iso"
          
          sudo proxmox-auto-install-assistant prepare-iso $WORKING_DIR/pve-original.iso \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml \
            --output $OUTPUT_PATH
          
          if [ ! -f "$OUTPUT_PATH" ]; then
            echo "FATAL: ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼Œå¯åŠ¨ç›®å½•æ·±åº¦æ‰«æï¼š"
            ls -R /tmp
            exit 1
          fi
          
          TIMESTAMP=$(date +%Y%m%d)
          FINAL_NAME="pve-ve-${{ needs.check-version.outputs.version }}-auto-512G-${TIMESTAMP}.iso"
          mv "$OUTPUT_PATH" "$WORKING_DIR/$FINAL_NAME"
          echo "FINAL_NAME=$FINAL_NAME" >> $GITHUB_ENV

      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}-${{ github.run_number }}
          name: Proxmox VE ${{ needs.check-version.outputs.version }} è‡ªåŠ¨åŒ–å®‰è£…é•œåƒ
          body: |
            ## ğŸš€ æ„å»ºå®Œæˆ
            - **åŸºç¡€é•œåƒ**: `${{ needs.check-version.outputs.latest_iso }}`
            - **ç½‘ç»œæ¨¡å¼**: `${{ steps.read_toml.outputs.addr }}`
            - **é»˜è®¤å¯†ç **: `${{ steps.read_toml.outputs.root_pwd }}`
            - **ç£ç›˜é…ç½®**: 512G é€‚é… (MaxRoot: 60G, No LVM-Thin)
          files: /tmp/pve-iso/${{ env.FINAL_NAME }}
          draft: false
          prerelease: false
