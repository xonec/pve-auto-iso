# å·¥ä½œæµåç§°
name: Build Latest PVE Unattended ISO

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ã€æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥æ–°ç‰ˆæœ¬ã€ä»“åº“push
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆé‡ç‚¹ï¼Œå¯éšæ—¶è·‘ï¼‰
  schedule:
    - cron: '0 14 * * *'  # UTCæ—¶é—´14ç‚¹=åŒ—äº¬æ—¶é—´22ç‚¹ï¼Ÿä¸å¯¹ï¼ŒUTC+8=åŒ—äº¬æ—¶é—´ï¼Œæ‰€ä»¥0 18 * * * æ˜¯åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-pve-iso.yml'
      - 'pve-unattended.toml'

# å·¥ä½œæµä»»åŠ¡
jobs:
  build-iso:
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntuæœ€æ–°ç‰ˆä½œä¸ºæ„å»ºç¯å¢ƒ
    permissions:
      contents: write  # æˆäºˆä¸Šä¼ Releasesçš„æƒé™

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆè·å–TOMLé…ç½®ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ–ï¼ˆæ·»åŠ Proxmoxæºï¼Œå®‰è£…æ„å»ºå·¥å…·ï¼‰
      - name: Install Dependencies
        run: |
          # æ·»åŠ Proxmoxå®˜æ–¹æºï¼ˆè·å–proxmox-auto-install-assistantï¼‰
          echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          sudo apt update
          # å®‰è£…å¿…è¦å·¥å…·
          sudo apt install -y wget proxmox-auto-install-assistant grep sed sort

      # æ­¥éª¤3ï¼šè‡ªåŠ¨è·å–æœ€æ–°PVE ISOç‰ˆæœ¬ï¼ˆæ ¸å¿ƒï¼šçˆ¬å–å®˜ç½‘ISOåˆ—è¡¨ï¼Œå–æœ€æ–°ï¼‰
      - name: Get Latest PVE ISO Version
        id: get_iso
        run: |
          # çˆ¬å–Proxmox ISOä¸‹è½½é¡µï¼Œæå–æ‰€æœ‰ISOæ–‡ä»¶åï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åºå–æœ€æ–°
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          # æå–ç‰ˆæœ¬å·ï¼ˆæ¯”å¦‚ä»proxmox-ve_9.1-1.isoæå–9.1-1ï¼‰
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          # è¾“å‡ºå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æœ€æ–°PVE ISOç‰ˆæœ¬ï¼š$LATEST_ISOï¼ˆç‰ˆæœ¬å·ï¼š$VERSIONï¼‰"

      # æ­¥éª¤4ï¼šä¸‹è½½æœ€æ–°PVEåŸç‰ˆISO
      - name: Download Latest PVE ISO
        run: |
          # åˆ›å»ºISOå­˜æ”¾ç›®å½•
          mkdir -p /tmp/pve-iso
          cd /tmp/pve-iso
          # ä¸‹è½½åŸç‰ˆISO
          wget --no-clobber https://enterprise.proxmox.com/iso/${{ steps.get_iso.outputs.latest_iso }}
          # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f "${{ steps.get_iso.outputs.latest_iso }}" ]; then
            echo "ISOä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi

      # æ­¥éª¤5ï¼šåˆ¶ä½œæ— äººå€¼å®ˆISOï¼ˆæ•´åˆTOMLé…ç½®ï¼‰
      - name: Build Unattended ISO
        run: |
          cd /tmp/pve-iso
          # è°ƒç”¨å·¥å…·ï¼Œæ•´åˆTOMLé…ç½®ç”Ÿæˆæ— äººå€¼å®ˆISO
          proxmox-auto-install-assistant prepare-iso ${{ steps.get_iso.outputs.latest_iso }} \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml
          # é‡å‘½åISOï¼ˆåŠ ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿è¯†åˆ«ï¼‰
          AUTO_ISO_NAME="proxmox-ve_${{ steps.get_iso.outputs.version }}-auto-install.iso"
          mv $(ls *-auto-from-iso.iso) $AUTO_ISO_NAME
          # è¾“å‡ºæœ€ç»ˆISOåç§°
          echo "auto_iso_name=$AUTO_ISO_NAME" >> $GITHUB_ENV
          echo "æ— äººå€¼å®ˆISOç”Ÿæˆå®Œæˆï¼š$AUTO_ISO_NAME"

      # æ­¥éª¤6ï¼šä¸Šä¼ ISOåˆ°GitHub Releases
      - name: Upload ISO to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_iso.outputs.version }}  # æŒ‰PVEç‰ˆæœ¬æ‰“æ ‡ç­¾
          name: PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…é•œåƒ
          body: |
            ğŸš€ PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…ISOï¼ˆé€‚é…å›½å†…åœºæ™¯ï¼‰
            - æ—¶åŒºï¼šAsia/Shanghai
            - ç½‘ç»œï¼šé™æ€IPï¼ˆ192.168.1.100/24ï¼Œå¯ä¿®æ”¹TOMLåé‡æ–°æ„å»ºï¼‰
            - å¯†ç ï¼šéœ€ä¿®æ”¹TOMLä¸­çš„root_passwordåä½¿ç”¨
          files: /tmp/pve-iso/${{ env.auto_iso_name }}  # è¦ä¸Šä¼ çš„ISOæ–‡ä»¶è·¯å¾„
          draft: false  # ä¸è®¾ä¸ºè‰ç¨¿ï¼Œç›´æ¥å‘å¸ƒ
          prerelease: false

      # æ­¥éª¤7ï¼šä¿å­˜ISOä½œä¸ºå·¥ä½œæµäº§ç‰©ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿ä¸´æ—¶ä¸‹è½½ï¼‰
      - name: Upload ISO as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pve-auto-install-iso
          path: /tmp/pve-iso/${{ env.auto_iso_name }}
          retention-days: 7  # äº§ç‰©ä¿ç•™7å¤©ï¼ˆé¿å…å ç©ºé—´ï¼‰
