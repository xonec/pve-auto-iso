# å·¥ä½œæµåç§°
name: Build Latest PVE Unattended ISO

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ã€æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥æ–°ç‰ˆæœ¬ã€ä»“åº“push
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆé‡ç‚¹ï¼Œå¯éšæ—¶è·‘ï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTCæ—¶é—´18ç‚¹ = åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ï¼ˆUTC+8ï¼‰
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-pve-iso.yml'
      - 'pve-unattended.toml'

# å·¥ä½œæµä»»åŠ¡
jobs:
  build-iso:
    runs-on: debian-latest  # æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ç”¨Debianæœ€æ–°ç‰ˆä½œä¸ºæ„å»ºç¯å¢ƒ
    permissions:
      contents: write  # æˆäºˆä¸Šä¼ Releasesçš„æƒé™

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆè·å–TOMLé…ç½®ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ–ï¼ˆé€‚é…Debianï¼Œä¿ç•™ä¹‹å‰çš„ä¿®å¤ç‚¹ï¼‰
      - name: Install Dependencies
        run: |
          # 1. æ›´æ–°Debianç³»ç»ŸåŸºç¡€åŒ…ï¼ˆDebiané»˜è®¤æ›´æ–°é¢‘ç‡ä½ï¼Œå…ˆæ›´åŸºç¡€åŒ…ï¼‰
          sudo apt update -y -qq
          sudo apt upgrade -y -qq
          # 2. æ·»åŠ Proxmoxå®˜æ–¹æºï¼ˆDebian bookwormé€‚é…PVE 9.xï¼‰
          echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          # 3. ä¸‹è½½Proxmox GPGå¯†é’¥ï¼ˆè§£å†³æƒé™+éªŒè¯ï¼‰
          sudo wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          # 4. éªŒè¯å¯†é’¥æ–‡ä»¶
          if [ ! -f "/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg" ]; then
            echo "GPGå¯†é’¥ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          # 5. æ›´æ–°åŒ…å«Proxmoxæºçš„aptç¼“å­˜
          sudo apt update -y -qq
          # 6. å®‰è£…å¿…è¦å·¥å…·ï¼ˆDebianè‡ªå¸¦sortï¼Œä»…è£…éœ€è¦çš„åŒ…ï¼‰
          sudo apt install -y -qq wget proxmox-auto-install-assistant grep sed

      # æ­¥éª¤3ï¼šè‡ªåŠ¨è·å–æœ€æ–°PVE ISOç‰ˆæœ¬
      - name: Get Latest PVE ISO Version
        id: get_iso
        run: |
          # çˆ¬å–Proxmox ISOä¸‹è½½é¡µï¼Œæå–æœ€æ–°ç‰ˆæœ¬
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          # è¾“å‡ºå˜é‡ä¾›åç»­ä½¿ç”¨
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æœ€æ–°PVE ISOç‰ˆæœ¬ï¼š$LATEST_ISOï¼ˆç‰ˆæœ¬å·ï¼š$VERSIONï¼‰"

      # æ­¥éª¤4ï¼šä¸‹è½½æœ€æ–°PVEåŸç‰ˆISO
      - name: Download Latest PVE ISO
        run: |
          mkdir -p /tmp/pve-iso
          cd /tmp/pve-iso
          # åŠ è¶…æ—¶ï¼Œé€‚é…Debianç½‘ç»œç¯å¢ƒ
          wget --no-clobber --timeout=300 https://enterprise.proxmox.com/iso/${{ steps.get_iso.outputs.latest_iso }}
          # éªŒè¯ä¸‹è½½
          if [ ! -f "${{ steps.get_iso.outputs.latest_iso }}" ]; then
            echo "ISOä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi

      # æ­¥éª¤5ï¼šåˆ¶ä½œæ— äººå€¼å®ˆISO
      - name: Build Unattended ISO
        run: |
          cd /tmp/pve-iso
          # Debianä¸‹éœ€sudoæ‰§è¡Œå·¥å…·ï¼Œç¡®ä¿æƒé™
          sudo proxmox-auto-install-assistant prepare-iso ${{ steps.get_iso.outputs.latest_iso }} \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml
          # é‡å‘½åISO
          AUTO_ISO_NAME="proxmox-ve_${{ steps.get_iso.outputs.version }}-auto-install.iso"
          mv $(ls *-auto-from-iso.iso) $AUTO_ISO_NAME
          echo "auto_iso_name=$AUTO_ISO_NAME" >> $GITHUB_ENV
          echo "æ— äººå€¼å®ˆISOç”Ÿæˆå®Œæˆï¼š$AUTO_ISO_NAME"

      # æ­¥éª¤6ï¼šä¸Šä¼ ISOåˆ°GitHub Releases
      - name: Upload ISO to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_iso.outputs.version }}
          name: PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…é•œåƒï¼ˆDebianæ„å»ºï¼‰
          body: |
            ğŸš€ PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…ISOï¼ˆåŸºäºDebianæ„å»ºï¼Œé€‚é…å›½å†…åœºæ™¯ï¼‰
            - æ—¶åŒºï¼šAsia/Shanghai
            - ç½‘ç»œï¼šé™æ€IPï¼ˆ192.168.1.100/24ï¼Œå¯ä¿®æ”¹TOMLåé‡æ–°æ„å»ºï¼‰
            - å¯†ç ï¼šéœ€ä¿®æ”¹TOMLä¸­çš„root_passwordåä½¿ç”¨
            - æ„å»ºç¯å¢ƒï¼šDebian latestï¼ˆè´´åˆPVEåº•å±‚ç³»ç»Ÿï¼Œå…¼å®¹æ€§æ›´ä½³ï¼‰
          files: /tmp/pve-iso/${{ env.auto_iso_name }}
          draft: false
          prerelease: false

      # æ­¥éª¤7ï¼šä¿å­˜ISOä½œä¸ºå·¥ä½œæµäº§ç‰©ï¼ˆå¯é€‰ï¼‰
      - name: Upload ISO as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pve-auto-install-iso-debian
          path: /tmp/pve-iso/${{ env.auto_iso_name }}
          retention-days: 7
