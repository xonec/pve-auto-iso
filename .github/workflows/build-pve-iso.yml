name: æ„å»ºæœ€æ–°ç‰ˆPVEæ— äººå€¼å®ˆå®‰è£…ISO

on:
  workflow_dispatch:  # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 18 * * *'  # æ¯å¤©å®šæ—¶æ£€æŸ¥ç‰ˆæœ¬

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.version_check.outputs.need_build }}
      latest_iso: ${{ steps.get_iso.outputs.latest_iso }}
      version: ${{ steps.get_iso.outputs.version }}
    steps:
      - name: è·å–å®˜ç½‘æœ€æ–°ISOç‰ˆæœ¬
        id: get_iso
        run: |
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ä»“åº“å·²å‘å¸ƒç‰ˆæœ¬
        id: version_check
        run: |
          # è·å–ä»“åº“æœ€æ–°Releaseçš„ç‰ˆæœ¬å·ï¼ˆåŒ¹é…vX.Y.Z-XXXæ ¼å¼ï¼‰
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep 'tag_name' | cut -d'"' -f4 | sed 's/^v//; s/-512G-.*//')
          # å¯¹æ¯”ç‰ˆæœ¬ï¼Œä¸ä¸€è‡´åˆ™æ ‡è®°éœ€è¦æ„å»º
          if [ "$LATEST_RELEASE" != "${{ steps.get_iso.outputs.version }}" ]; then
            echo "æ£€æµ‹åˆ°æ–°ç‰ˆISOï¼š${{ steps.get_iso.outputs.version }}"
            echo "need_build=true" >> $GITHUB_OUTPUT
          else
            echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼š${{ steps.get_iso.outputs.version }}"
            echo "need_build=false" >> $GITHUB_OUTPUT
          fi

  build-iso:
    needs: check-version
    if: ${{ needs.check-version.outputs.need_build == 'true' }}  # ç‰ˆæœ¬ä¸ä¸€è‡´æ‰æ„å»º
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg] http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          sudo wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          if ! gpg --show-keys /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg | grep -q "Proxmox Release Key"; then
            echo "GPGå¯†é’¥éªŒè¯å¤±è´¥ï¼"
            exit 1
          fi
          sudo apt update -y -qq
          sudo apt install -y -qq wget proxmox-auto-install-assistant grep sed

      - name: ç”Ÿæˆæ„å»ºæ—¶é—´æˆ³
        id: gen_timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: è¯»å–TOMLé…ç½®å…³é”®å€¼
        id: read_toml
        run: |
          ROOT_PWD=$(grep 'root_password =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
          NET_MODE=$(grep 'source =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
          if [ "$NET_MODE" = "from-answer" ]; then
            IP=$(grep 'cidr =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
            GATEWAY=$(grep 'gateway =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
            DNS=$(grep 'dns =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
            ADDR="é™æ€IPï¼š$IP | ç½‘å…³ï¼š$GATEWAY | DNSï¼š$DNS"
          else
            ADDR="DHCPè‡ªåŠ¨è·å–IP"
          fi
          echo "root_pwd=$ROOT_PWD" >> $GITHUB_OUTPUT
          echo "addr=$ADDR" >> $GITHUB_OUTPUT
          echo "net_mode=$NET_MODE" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æœ€æ–°PVEåŸç‰ˆISO
        run: |
          mkdir -p /tmp/pve-iso
          cd /tmp/pve-iso
          wget --no-clobber --timeout=300 https://enterprise.proxmox.com/iso/${{ needs.check-version.outputs.latest_iso }}
          if [ ! -f "${{ needs.check-version.outputs.latest_iso }}" ]; then
            echo "PVEåŸç‰ˆISOä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi

      - name: åˆ¶ä½œæ— äººå€¼å®ˆå®‰è£…ISO
        run: |
          cd /tmp/pve-iso
          sudo proxmox-auto-install-assistant prepare-iso ${{ needs.check-version.outputs.latest_iso }} \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml
          # ç²¾å‡†åŒ¹é…ç”Ÿæˆçš„æ— äººå€¼å®ˆISO
          AUTO_ISO_RAW=$(find . -maxdepth 1 -name "${{ needs.check-version.outputs.latest_iso }}.auto-from-iso.iso" -print -quit)
          if [ -z "$AUTO_ISO_RAW" ]; then
            echo "æ— äººå€¼å®ˆISOç”Ÿæˆå¤±è´¥ï¼"
            exit 1
          fi
          AUTO_ISO_NAME="proxmox-ve_${{ needs.check-version.outputs.version }}-æ— äººå€¼å®ˆå®‰è£…_512G_${{ steps.gen_timestamp.outputs.timestamp }}.iso"
          mv "$AUTO_ISO_RAW" "$AUTO_ISO_NAME"
          echo "auto_iso_name=$AUTO_ISO_NAME" >> $GITHUB_ENV

      - name: ä¸Šä¼ ISOåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}-512G-${{ steps.gen_timestamp.outputs.timestamp }}
          name: PVE ${{ needs.check-version.outputs.version }} æ— äººå€¼å®ˆå®‰è£…é•œåƒï¼ˆ512Gç¡¬ç›˜é€‚é…ï¼‰
          body: |
            ğŸš€ PVEæ— äººå€¼å®ˆå®‰è£…é•œåƒï¼ˆæ ¸å¿ƒé…ç½®ï¼‰
            â”œâ”€ PVEç‰ˆæœ¬å·ï¼š${{ needs.check-version.outputs.version }}
            â”œâ”€ ç½‘ç»œåœ°å€ï¼š${{ steps.read_toml.outputs.addr }}
            â”œâ”€ ç®¡ç†å‘˜è´¦å·ï¼šroot
            â”œâ”€ ç®¡ç†å‘˜å¯†ç ï¼š${{ steps.read_toml.outputs.root_pwd }}
            â””â”€ é€‚ç”¨ç¡¬ç›˜ï¼š512Gï¼ˆLVMåˆ†åŒºå·²é€‚é…ï¼‰
          files: /tmp/pve-iso/${{ env.auto_iso_name }}
          overwrite_files: true
          draft: false
          prerelease: false

      - name: ä¸Šä¼ ISOä½œä¸ºå·¥ä½œæµä¸´æ—¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: pve-æ— äººå€¼å®ˆå®‰è£…é•œåƒ_512G_${{ steps.gen_timestamp.outputs.timestamp }}
          path: /tmp/pve-iso/${{ env.auto_iso_name }}
          retention-days: 7

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: rm -rf /tmp/pve-iso
