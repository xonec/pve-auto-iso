# å·¥ä½œæµåç§°
name: Build Latest PVE Unattended ISO

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-pve-iso.yml'
      - 'pve-unattended.toml'

jobs:
  build-iso:
    runs-on: ubuntu-latest  # æ”¹å›GitHubå®˜æ–¹æ”¯æŒçš„Ubuntuï¼ˆåŸºäºDebianï¼Œå…¼å®¹PVEï¼‰
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # æ·»åŠ Proxmoxæº+å®‰è£…ä¾èµ–ï¼ˆä¿®å¤åçš„å‘½ä»¤ï¼‰
          echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          sudo wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          if [ ! -f "/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg" ]; then
            echo "GPGå¯†é’¥ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          sudo apt update -y -qq
          sudo apt install -y -qq wget proxmox-auto-install-assistant grep sed

      - name: Get Latest PVE ISO Version
        id: get_iso
        run: |
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Latest PVE ISO
        run: |
          mkdir -p /tmp/pve-iso
          cd /tmp/pve-iso
          wget --no-clobber --timeout=300 https://enterprise.proxmox.com/iso/${{ steps.get_iso.outputs.latest_iso }}
          if [ ! -f "${{ steps.get_iso.outputs.latest_iso }}" ]; then
            echo "ISOä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi

      - name: Build Unattended ISO
        run: |
          cd /tmp/pve-iso
          sudo proxmox-auto-install-assistant prepare-iso ${{ steps.get_iso.outputs.latest_iso }} \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml
          AUTO_ISO_NAME="proxmox-ve_${{ steps.get_iso.outputs.version }}-auto-install.iso"
          mv $(ls *-auto-from-iso.iso) $AUTO_ISO_NAME
          echo "auto_iso_name=$AUTO_ISO_NAME" >> $GITHUB_ENV

      - name: Upload ISO to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_iso.outputs.version }}
          name: PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…é•œåƒ
          body: |
            ğŸš€ PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…ISOï¼ˆé€‚é…å›½å†…åœºæ™¯ï¼‰
            - æ—¶åŒºï¼šAsia/Shanghai
            - ç½‘ç»œï¼šé™æ€IPï¼ˆ192.168.1.100/24ï¼Œå¯ä¿®æ”¹TOMLï¼‰
            - å¯†ç ï¼šéœ€ä¿®æ”¹TOMLä¸­çš„root_password
          files: /tmp/pve-iso/${{ env.auto_iso_name }}
          draft: false
          prerelease: false

      - name: Upload ISO as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pve-auto-install-iso
          path: /tmp/pve-iso/${{ env.auto_iso_name }}
          retention-days: 7
