# å·¥ä½œæµåç§°ï¼ˆä¸­æ–‡ï¼‰
name: æ„å»ºæœ€æ–°ç‰ˆPVEæ— äººå€¼å®ˆå®‰è£…ISO

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 18 * * *'  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹å®šæ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-pve-iso.yml'
      - 'pve-unattended.toml'

jobs:
  build-iso:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          sudo wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          if [ ! -f "/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg" ]; then
            echo "GPGå¯†é’¥ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          sudo apt update -y -qq
          sudo apt install -y -qq wget proxmox-auto-install-assistant grep sed

      - name: è·å–æœ€æ–°PVE ISOç‰ˆæœ¬
        id: get_iso
        run: |
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ç”Ÿæˆå”¯ä¸€æ—¶é—´æˆ³ï¼ˆè§£å†³æ–‡ä»¶é‡åæ ¸å¿ƒï¼‰
      - name: ç”Ÿæˆæ„å»ºæ—¶é—´æˆ³
        id: gen_timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)  # ç§’çº§æ—¶é—´æˆ³ï¼Œç¡®ä¿å”¯ä¸€
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      # è¯»å–TOMLé…ç½®å…³é”®å€¼
      - name: è¯»å–TOMLé…ç½®å…³é”®å€¼
        id: read_toml
        run: |
          # è¯»å–ç®¡ç†å‘˜å¯†ç ï¼ˆroot_passwordï¼‰
          ROOT_PWD=$(grep 'root_password =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
          # è¯»å–ç½‘ç»œæ¨¡å¼ï¼ˆfrom-dhcp/from-answerï¼‰
          NET_MODE=$(grep 'source =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
          
          # æ ¹æ®ç½‘ç»œæ¨¡å¼è¯»å–åœ°å€ä¿¡æ¯
          if [ "$NET_MODE" = "from-answer" ]; then
            # é™æ€IPæ¨¡å¼ï¼šè¯»å–IPã€ç½‘å…³ã€DNS
            IP=$(grep 'cidr =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
            GATEWAY=$(grep 'gateway =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
            DNS=$(grep 'dns =' $GITHUB_WORKSPACE/pve-unattended.toml | awk -F'"' '{print $2}')
            ADDR="é™æ€IPï¼š$IP | ç½‘å…³ï¼š$GATEWAY | DNSï¼š$DNS"
          else
            # DHCPæ¨¡å¼ï¼šæ˜¾ç¤ºè‡ªåŠ¨è·å–
            ADDR="DHCPè‡ªåŠ¨è·å–IP"
          fi
          
          # è¾“å‡ºå˜é‡ä¾›Bodyä½¿ç”¨
          echo "root_pwd=$ROOT_PWD" >> $GITHUB_OUTPUT
          echo "addr=$ADDR" >> $GITHUB_OUTPUT
          echo "net_mode=$NET_MODE" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æœ€æ–°PVEåŸç‰ˆISO
        run: |
          mkdir -p /tmp/pve-iso
          cd /tmp/pve-iso
          wget --no-clobber --timeout=300 https://enterprise.proxmox.com/iso/${{ steps.get_iso.outputs.latest_iso }}
          if [ ! -f "${{ steps.get_iso.outputs.latest_iso }}" ]; then
            echo "PVEåŸç‰ˆISOä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi

      - name: åˆ¶ä½œæ— äººå€¼å®ˆå®‰è£…ISO
        run: |
          cd /tmp/pve-iso
          sudo proxmox-auto-install-assistant prepare-iso ${{ steps.get_iso.outputs.latest_iso }} \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml
          # æ–‡ä»¶åæ·»åŠ æ—¶é—´æˆ³ï¼Œå½»åº•é¿å…é‡å
          AUTO_ISO_NAME="proxmox-ve_${{ steps.get_iso.outputs.version }}-æ— äººå€¼å®ˆå®‰è£…_512G_${{ steps.gen_timestamp.outputs.timestamp }}.iso"
          mv $(ls *-auto-from-iso.iso) $AUTO_ISO_NAME
          echo "auto_iso_name=$AUTO_ISO_NAME" >> $GITHUB_ENV

      - name: ä¸Šä¼ ISOåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          # æ ‡ç­¾æ·»åŠ æ—¶é—´æˆ³ï¼Œé¿å…åŒç‰ˆæœ¬æ ‡ç­¾é‡å¤
          tag_name: v${{ steps.get_iso.outputs.version }}-512G-${{ steps.gen_timestamp.outputs.timestamp }}
          name: PVE ${{ steps.get_iso.outputs.version }} æ— äººå€¼å®ˆå®‰è£…é•œåƒï¼ˆ512Gç¡¬ç›˜é€‚é…ï¼‰
          # Bodyä¿ç•™æ ¸å¿ƒä¿¡æ¯+512Gæ ‡æ³¨
          body: |
            ğŸš€ PVEæ— äººå€¼å®ˆå®‰è£…é•œåƒï¼ˆæ ¸å¿ƒé…ç½®ï¼‰
            â”œâ”€ PVEç‰ˆæœ¬å·ï¼š${{ steps.get_iso.outputs.version }}
            â”œâ”€ ç½‘ç»œåœ°å€ï¼š${{ steps.read_toml.outputs.addr }}
            â”œâ”€ ç®¡ç†å‘˜è´¦å·ï¼šroot
            â”œâ”€ ç®¡ç†å‘˜å¯†ç ï¼š${{ steps.read_toml.outputs.root_pwd }}
            â””â”€ é€‚ç”¨ç¡¬ç›˜ï¼š512Gï¼ˆLVMåˆ†åŒºå·²é€‚é…ï¼‰
          files: /tmp/pve-iso/${{ env.auto_iso_name }}
          draft: false
          prerelease: false
          # æ­£ç¡®çš„æ–‡ä»¶è¦†ç›–å‚æ•°ï¼ˆæ›¿ä»£æ— æ•ˆçš„overwriteï¼‰
          overwrite_files: true

      - name: ä¸Šä¼ ISOä½œä¸ºå·¥ä½œæµä¸´æ—¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          # äº§ç‰©åæ·»åŠ æ—¶é—´æˆ³ï¼Œé¿å…å†²çª
          name: pve-æ— äººå€¼å®ˆå®‰è£…é•œåƒ_512G_${{ steps.gen_timestamp.outputs.timestamp }}
          path: /tmp/pve-iso/${{ env.auto_iso_name }}
          retention-days: 7
