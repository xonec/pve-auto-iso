name: 构建最新版 PVE 无人值守安装 ISO

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.version_check.outputs.need_build }}
      latest_iso: ${{ steps.get_iso.outputs.latest_iso }}
      version: ${{ steps.get_iso.outputs.version }}
    steps:
      - name: 获取官网最新 ISO 版本
        id: get_iso
        run: |
          ISO_LIST=$(curl -s https://enterprise.proxmox.com/iso/ | grep -o 'proxmox-ve_[0-9.]*-[0-9]*.iso' | sort -Vr)
          LATEST_ISO=$(echo "$ISO_LIST" | head -n 1)
          VERSION=$(echo $LATEST_ISO | sed 's/proxmox-ve_//; s/.iso//')
          echo "latest_iso=$LATEST_ISO" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: 检查仓库已发布版本
        id: version_check
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep 'tag_name' | cut -d'"' -f4 | sed 's/^v//; s/-512G-.*//' || echo "0.0-0")
          if [ "$LATEST_RELEASE" != "${{ steps.get_iso.outputs.version }}" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
          fi

  build-iso:
    needs: check-version
    if: ${{ needs.check-version.outputs.need_build == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装构建依赖
        run: |
          # 使用 dearmor 解决 GPG 验证失败问题
          curl -fsSL https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg] http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee /etc/apt/sources.list.d/pve.list
          sudo apt update -y
          # 补充 ISO 制作必需的底层工具
          sudo apt install -y proxmox-auto-install-assistant mtools libisoburn1 wget

      - name: 读取 TOML 配置
        id: read_toml
        run: |
          # 健壮的正则提取函数
          extract_val() { grep "$1" pve-unattended.toml | sed -E 's/.*=[[:space:]]*"(.*)"/\1/'; }
          
          ROOT_PWD=$(extract_val "root_password")
          NET_MODE=$(extract_val "source")
          
          if [ "$NET_MODE" = "from-answer" ]; then
            IP=$(extract_val "cidr")
            ADDR="静态IP: $IP"
          else
            ADDR="DHCP 自动获取"
          fi
          echo "root_pwd=$ROOT_PWD" >> $GITHUB_OUTPUT
          echo "addr=$ADDR" >> $GITHUB_OUTPUT

      - name: 下载 PVE 原版 ISO
        run: |
          mkdir -p /tmp/pve-iso
          wget --tries=3 --timeout=300 -O /tmp/pve-iso/pve-original.iso https://enterprise.proxmox.com/iso/${{ needs.check-version.outputs.latest_iso }}

      - name: 制作无人值守 ISO
        run: |
          cd /tmp/pve-iso
          # 使用 assistant 注入配置文件
          sudo proxmox-auto-install-assistant prepare-iso pve-original.iso \
            --fetch-from iso \
            --answer-file $GITHUB_WORKSPACE/pve-unattended.toml
          
          # 重命名产物
          TIMESTAMP=$(date +%Y%m%d)
          FINAL_NAME="pve-auto-${{ needs.check-version.outputs.version }}-512G-${TIMESTAMP}.iso"
          mv pve-original.auto-from-iso.iso "$FINAL_NAME"
          echo "FINAL_NAME=$FINAL_NAME" >> $GITHUB_ENV

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}-${{ strategy.job-index }}-${{ github.run_number }}
          name: Proxmox VE ${{ needs.check-version.outputs.version }} 自动化镜像
          body: |
            ## 自动化构建报告
            - **基础版本**: `${{ needs.check-version.outputs.version }}`
            - **网络模式**: `${{ steps.read_toml.outputs.addr }}`
            - **默认密码**: `${{ steps.read_toml.outputs.root_pwd }}`
            - **分区方案**: 512G 适配 (MaxRoot: 60GB, No LVM-Thin)
          files: /tmp/pve-iso/${{ env.FINAL_NAME }}
